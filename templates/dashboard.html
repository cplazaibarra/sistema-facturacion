{% extends "base.html" %}

{% block title %}Dashboard - FacturaciÃ³n Bodega Miel{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<!-- Tarjetas de estadÃ­sticas -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon blue">ðŸ’°</div>
        <div class="stat-info">
            <div class="stat-value" id="ventas-hoy">$0</div>
            <div class="stat-label">Ventas Hoy</div>
        </div>
        <div class="stat-trend positive">+12.5%</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon cyan">ðŸ“¦</div>
        <div class="stat-info">
            <div class="stat-value" id="productos-stock">0</div>
            <div class="stat-label">Productos en Stock</div>
        </div>
        <div class="stat-trend positive">+5.2%</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon purple">ðŸ“‹</div>
        <div class="stat-info">
            <div class="stat-value" id="ordenes-pendientes">0</div>
            <div class="stat-label">Ã“rdenes Pendientes</div>
        </div>
        <div class="stat-trend negative">-2.4%</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon green">ðŸ‘¥</div>
        <div class="stat-info">
            <div class="stat-value" id="clientes-activos">0</div>
            <div class="stat-label">Clientes Activos</div>
        </div>
        <div class="stat-trend positive">+8.1%</div>
    </div>
</div>

<!-- GrÃ¡ficos -->
<div class="charts-grid">
    <div class="chart-card">
        <div class="card-header">
            <h3>Ventas Mensuales</h3>
            <select class="period-selector" id="sales-period-selector">
                <option value="6months">Ãšltimos 6 meses</option>
                <option value="12months">Ãšltimo aÃ±o</option>
                <option value="2026">AÃ±o 2026</option>
                <option value="2025">AÃ±o 2025</option>
            </select>
        </div>
        <canvas id="ventasChart"></canvas>
    </div>
    
    <div class="chart-card">
        <div class="card-header">
            <h3>Productos MÃ¡s Vendidos</h3>
            <select class="period-selector" id="products-period-selector">
                <option value="month">Este mes</option>
                <option value="year">Este aÃ±o</option>
                <option value="2026">AÃ±o 2026</option>
                <option value="2025">AÃ±o 2025</option>
            </select>
        </div>
        <canvas id="productosChart"></canvas>
    </div>
</div>

<!-- Tablas de datos recientes -->
<div class="recent-section">
    <div class="recent-card">
        <div class="card-header">
            <h3>Ãšltimas Ventas</h3>
            <a href="#" class="view-all">Ver todas â†’</a>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Cliente</th>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Total</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody>
                {% for sale in recent_sales %}
                <tr>
                    <td>{{ sale.id }}</td>
                    <td>{{ sale.cliente }}</td>
                    <td>{{ sale.producto }}</td>
                    <td>{{ sale.cantidad }}</td>
                    <td>${{ "%.2f"|format(sale.total) }}</td>
                    <td>
                        {% if sale.estado == 'Completado' %}
                        <span class="badge success">{{ sale.estado }}</span>
                        {% elif sale.estado == 'Pendiente' %}
                        <span class="badge warning">{{ sale.estado }}</span>
                        {% else %}
                        <span class="badge danger">{{ sale.estado }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let ventasChart = null;
    let productosChart = null;

    // FunciÃ³n para cargar SOLO el grÃ¡fico de Ventas Mensuales
    function loadSalesChart() {
        const salesPeriod = document.getElementById('sales-period-selector').value;
        
        // Construir URL con parÃ¡metros
        let params = new URLSearchParams();
        
        // Determinar parÃ¡metros para ventas
        if (salesPeriod === '6months' || salesPeriod === '12months') {
            params.append('sales_period', salesPeriod);
        } else {
            params.append('sales_year', salesPeriod);
            params.append('sales_period', '12months');
        }
        
        fetch(`/api/dashboard-data?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                // Actualizar o crear grÃ¡fico de ventas mensuales
                const ventasCtx = document.getElementById('ventasChart').getContext('2d');
                
                // Destruir grÃ¡fico anterior si existe
                if (ventasChart) {
                    ventasChart.destroy();
                }
                
                // Crear nuevo grÃ¡fico
                ventasChart = new Chart(ventasCtx, {
                    type: 'bar',
                    data: {
                        labels: data.ventas_mensuales.labels,
                        datasets: [{
                            label: 'Ventas ($)',
                            data: data.ventas_mensuales.data,
                            backgroundColor: 'rgba(0, 174, 239, 0.8)',
                            borderColor: 'rgba(0, 174, 239, 1)',
                            borderWidth: 1,
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            });
    }

    // FunciÃ³n para cargar SOLO el grÃ¡fico de Productos MÃ¡s Vendidos
    function loadProductsChart() {
        const productsPeriod = document.getElementById('products-period-selector').value;
        
        // Construir URL con parÃ¡metros
        let params = new URLSearchParams();
        
        // Determinar parÃ¡metros para productos
        if (productsPeriod === 'month' || productsPeriod === 'year') {
            params.append('products_period', productsPeriod);
        } else {
            params.append('products_year', productsPeriod);
            params.append('products_period', 'year');
        }
        
        fetch(`/api/dashboard-data?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                // Actualizar o crear grÃ¡fico de productos mÃ¡s vendidos
                const productosCtx = document.getElementById('productosChart').getContext('2d');
                
                // Destruir grÃ¡fico anterior si existe
                if (productosChart) {
                    productosChart.destroy();
                }
                
                // Crear nuevo grÃ¡fico
                productosChart = new Chart(productosCtx, {
                    type: 'doughnut',
                    data: {
                        labels: data.productos_top.labels,
                        datasets: [{
                            data: data.productos_top.data,
                            backgroundColor: [
                                'rgba(0, 174, 239, 0.8)',
                                'rgba(0, 209, 178, 0.8)',
                                'rgba(107, 91, 149, 0.8)',
                                'rgba(255, 159, 64, 0.8)',
                                'rgba(255, 99, 132, 0.8)'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            });
    }

    // FunciÃ³n para cargar ambos grÃ¡ficos con datos iniciales
    function loadInitialData() {
        // Cargar estadÃ­sticas
        fetch('/api/dashboard-data')
            .then(response => response.json())
            .then(data => {
                document.getElementById('ventas-hoy').textContent = '$' + data.estadisticas.ventas_hoy.toLocaleString();
                document.getElementById('productos-stock').textContent = data.estadisticas.productos_stock.toLocaleString();
                document.getElementById('ordenes-pendientes').textContent = data.estadisticas.ordenes_pendientes;
                document.getElementById('clientes-activos').textContent = data.estadisticas.clientes_activos;
            });
        
        // Cargar grÃ¡ficos
        loadSalesChart();
        loadProductsChart();
    }

    // Cargar datos iniciales cuando carga la pÃ¡gina
    loadInitialData();

    // Event listeners INDEPENDIENTES para cada selector
    document.getElementById('sales-period-selector').addEventListener('change', loadSalesChart);
    document.getElementById('products-period-selector').addEventListener('change', loadProductsChart);
</script>
{% endblock %}
