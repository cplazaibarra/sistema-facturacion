{% extends "base.html" %}

{% block title %}Usuarios - Facturación Bodega Miel{% endblock %}
{% block page_title %}Usuarios{% endblock %}

{% block content %}
<!-- Botón para agregar usuario -->
<div class="header-section">
    <button class="btn-primary" onclick="toggleFormulario()">
        ➕ Nuevo Usuario
    </button>
</div>

<!-- Formulario oculto para agregar usuario -->
<div class="settings-section" id="formulario-usuario" style="display: none;">
    <div class="settings-card">
        <div class="card-header">
            <h3>Agregar Nuevo Usuario</h3>
            <button class="btn-secondary" onclick="toggleFormulario()">Cerrar</button>
        </div>
        <form class="settings-form" method="POST">
            <div class="form-row">
                <div class="form-group">
                    <label>Nombre de Usuario *</label>
                    <input type="text" name="username" class="form-control" placeholder="usuario123" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="email" class="form-control" placeholder="usuario@bodegamiel.com" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Nombre Completo *</label>
                    <input type="text" name="full_name" class="form-control" placeholder="Juan Pérez" required>
                </div>
                <div class="form-group">
                    <label>Rol *</label>
                    <select name="role_id" class="form-control" required>
                        <option value="">-- Seleccionar Rol --</option>
                        {% for role in roles %}
                        <option value="{{ role.id }}">{{ role.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Contraseña</label>
                <input type="password" name="password" class="form-control" placeholder="Dejar en blanco para usar contraseña por defecto">
                <small>Si no ingresa contraseña, se usará "password123"</small>
            </div>

            <div class="form-group">
                <label>
                    <input type="checkbox" name="is_active" value="1" checked>
                    Activo
                </label>
            </div>

            <div class="form-actions">
                <button type="reset" class="btn-secondary">Limpiar</button>
                <button type="submit" class="btn-primary">Guardar Usuario</button>
            </div>
        </form>
    </div>
</div>

<!-- Lista de usuarios -->
<div class="recent-section">
    <div class="recent-card">
        <div class="card-header">
            <h3>Usuarios Registrados</h3>
            <span class="badge">{{ users|length }} usuarios</span>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Usuario</th>
                    <th>Email</th>
                    <th>Nombre</th>
                    <th>Rol</th>
                    <th>Estado</th>
                    <th>Creado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>
                        <strong>{{ user.username }}</strong>
                    </td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.full_name }}</td>
                    <td>
                        <span class="badge" style="background-color: #0070D2; color: white;">
                            {{ user.role_name }}
                        </span>
                    </td>
                    <td>
                        {% if user.is_active %}
                        <span class="badge" style="background-color: #00D1B2; color: white;">Activo</span>
                        {% else %}
                        <span class="badge" style="background-color: #D91C1C; color: white;">Inactivo</span>
                        {% endif %}
                    </td>
                    <td>{{ user.created_at[:10] }}</td>
                    <td>
                        <a href="{{ url_for('editar_usuario', user_id=user.id) }}" class="btn-small">Editar</a>
                        <form method="POST" action="{{ url_for('eliminar_usuario', user_id=user.id) }}" style="display: inline;" onsubmit="return confirm('¿Estás seguro?');">
                            <button type="submit" class="btn-small" style="background-color: #D91C1C;">Eliminar</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Sección de Roles -->
<div class="recent-section">
    <div class="recent-card">
        <div class="card-header">
            <h3>Roles Definidos</h3>
            <a href="{{ url_for('roles') }}" class="btn-small">Gestionar Roles</a>
        </div>
        <div class="roles-grid">
            {% for role in roles %}
            <div class="role-card">
                <h4>{{ role.name }}</h4>
                <p>{{ role.description }}</p>
                <div class="role-permissions">
                    {% if role.permissions %}
                        {% set perm_dict = role.permissions|from_json %}
                        <ul>
                            {% for perm, value in perm_dict.items() %}
                            <li>
                                {% if value %}
                                ✓ {{ perm|replace('_', ' ')|title }}
                                {% else %}
                                ✗ {{ perm|replace('_', ' ')|title }}
                                {% endif %}
                            </li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<style>
.badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 500;
}

.btn-small {
    padding: 6px 12px;
    background-color: #0070D2;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
    font-size: 0.85rem;
}

.btn-small:hover {
    background-color: #0056B3;
}

.roles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.role-card {
    border: 1px solid #E5E7EB;
    border-radius: 8px;
    padding: 16px;
    background: #F9FAFB;
}

.role-card h4 {
    margin: 0 0 8px 0;
    color: #0070D2;
}

.role-card p {
    margin: 0 0 12px 0;
    color: #666;
    font-size: 0.9rem;
}

.role-permissions ul {
    margin: 0;
    padding-left: 20px;
    font-size: 0.85rem;
    color: #555;
}

.role-permissions li {
    margin: 4px 0;
}

.header-section {
    margin-bottom: 20px;
}
</style>

<script>
function toggleFormulario() {
    const formulario = document.getElementById('formulario-usuario');
    if (formulario.style.display === 'none') {
        formulario.style.display = 'block';
        formulario.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } else {
        formulario.style.display = 'none';
    }
}
</script>

{% endblock %}
